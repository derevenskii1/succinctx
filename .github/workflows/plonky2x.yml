name: plonky2x

on:
  push:
    branches: [main]
  pull_request:
    branches:
      - "**"
    paths:
      - "plonky2x/**"
  workflow_dispatch:
    branches:
      - "**"

jobs:
  test-and-lints:
    name: Test Suite & Linting
    runs-on: buildjet-32vcpu-ubuntu-2204
    if: "!(contains(toJSON(github.event.commits.*.message), '[skip-ci]'))"
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2

      - name: Cache Rust dependencies
        uses: actions/cache@v2
        with:
          path: |
            ~/.cargo/
            target/
          key: ${{ runner.os }}-rust-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-rust-

      - name: Install and setup Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: ${{ matrix.rust-version }}
          override: true
          components: rustfmt, clippy

      - name: Run cargo test
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: --release --features "ci"
        env:
          RUST_LOG: 1
          RUST_BACKTRACE: 1

      - name: Run cargo fmt
        uses: actions-rs/cargo@v1
        with:
          command: fmt
          args: --all -- --check
        env:
          CARGO_INCREMENTAL: 1

      - name: Run cargo clippy
        uses: actions-rs/cargo@v1
        with:
          command: clippy
          args: --all-features --all-targets -- -D warnings -A incomplete-features
        env:
          CARGO_INCREMENTAL: 1
    strategy:
      matrix:
        rust-version: [nightly-2024-02-22]  # Add other versions as needed
